---
title: "Almond Profit Model"
format: html
warning: false
---

```{r}
#| output: false 
#| warning: false 
#| echo: false
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(patchwork)
```

## Load Data and function 
```{r}
almonds <- read.table(here::here("assignment3", "clim.txt"), 
           header = TRUE)

source(here::here("assignment3","R", "almond_profit_function.R"))

```

## Prices
Create a list of almond prices over the years 

From *United States Department of Agriculture National Agricultural Statistics Service: 2024 California Almond Objective Measurement Report*
```{r}
#| warnings: false 
p <- c(2.48, 2.08, 1.56, 1.41, 0.86, 0.97, 0.91, 1.11, 1.57, 2.21, 2.81, 2.06, 1.75, 1.45, 1.65, 1.79, 1.99, 2.58, 3.21, 4.00, 3.13, 2.39, 2.53, 2.50, 2.45, 1.71, 1.86, 1.40, 1.40)
  
```

## Run function 
```{r}
almond_profit_function(almond_df = almonds, prices = p)
```


# Sensitivity Analysis 

1) Varies the temperature and precipitation inputs + price + discount rate
2) Runs function for various simulations
3) Extracts mean profit

```{r}
# Generate parameter samples: tmin, precip, discount rate, and price 
nsamples <- 300 # number of samples
mean_tmin <- rnorm(mean = 12, sd = 2, n = nsamples)
mean_precip <- rnorm(mean = 1, sd = 0.5, n = nsamples)

dis_rate <- rnorm(mean = 0.08, sd = 0.015, n = nsamples)

price_base <- 1.50
price_sd <- 0.80
p <- runif(max = price_base + price_sd * price_base, 
          min = price_base - price_sd * price_base, 
          n = nsamples) 


# Put samples together
parms <- cbind.data.frame(mean_tmin, mean_precip, dis_rate, p)


# RUN THE SIMULATION OVER THE 300 SAMPLES 
# Use pmap with wrapper (because your function needs a dataframe, not scalars like the solar model). 
# `results` is results of 300 different simulations   
results <- parms %>% 
  pmap(function(mean_tmin, mean_precip, dis_rate, p) {
    almond_df <- data.frame(
      tmin_c = rnorm(mean = mean_tmin, sd = 3, n = 40),
      precip = rnorm(mean = mean_precip, sd = 2, n = 40),
      month = c(rep(1, 20), rep(2, 20)),
      year = rep(1981:2000, times = 2)
      )
    almond_profit_function(almond_df, prices = p, discount_rate = dis_rate)
})

# Extract mean profit column from each simulation result 
mean_profit <- map_dbl(results, ~mean(.x$profit, na.rm = TRUE))
#mean_profit <- map_df(results, `[`, c("mean"))

# Add parameter values
mean_profit <- cbind.data.frame(mean_profit, parms)

head(mean_profit)

```

# Graphs
```{r}

# 1) box or violin of mean_profit 
ggplot(mean_profit) + 
  geom_boxplot(aes(y = mean_profit), fill = "#ffad76") + 
  labs(y = "Mean Profit ($/acre)", 
       title = "Distribution of Almond Profit across various Simulations") + 
  theme_bw()


# 2). Parameter SENSITIVITY - profit responds to each parameter
# Temperature sensitivity (and mean_profit)
plot_tmin <- ggplot(mean_profit, aes(x = mean_tmin, y = mean_profit)) + 
  geom_point(col = "sandybrown", 
             alpha = 0.8) + 
  geom_smooth(col = "firebrick") + 
  theme_minimal() + 
  labs(x = "Mean Minimum Temperature (C)", 
       y = "Mean Almond Profit ($/acre)", 
       title = "Almond Profit in Reponse to Temperature Variation") 


# Precipitation sensitivity (and mean_profit)
plot_precip <- ggplot(mean_profit, aes(x = mean_precip, y = mean_profit)) + 
  geom_point(col = "skyblue2", 
             alpha = 0.8) + 
  geom_smooth(col = "firebrick") + 
  theme_minimal() + 
  labs(x = "Mean Minimum Precipitation", 
       y = "Mean Almond Profit ($/acre)", 
       title = "Almond Profit in Reponse to Precipitation Variation") 


# Price sensitivity (and mean_profit)
plot_price <- ggplot(mean_profit, aes(x = p, y = mean_profit)) + 
  geom_point(col = "seagreen3", 
             alpha = 0.8) + 
  geom_smooth(col = "firebrick") + 
  theme_minimal() + 
  labs(x = "Almond Price ($/lb)", 
       y = "Mean Almond Profit ($/acre)", 
       title = "Almond Profit in Reponse to Price Variation") 

# Discount Rate sensitivity (and mean_profit)
plot_discount <- ggplot(mean_profit, aes(x = dis_rate, y = mean_profit)) + 
  geom_point(col = "plum", 
             alpha = 0.8) + 
  geom_smooth(col = "firebrick") + 
  theme_minimal() + 
  labs(x = "Discount Rate", 
       y = "Mean Almond Profit ($/acre)", 
       title = "Almond Profit in Reponse to Discount Rate Variation") 


main_plot <- (plot_tmin + plot_precip) / (plot_price + plot_discount)
ggsave(here::here("figs", "assignment4_sensitive_analysis.png"), height = 10, width = 10)
```

